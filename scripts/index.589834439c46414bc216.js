!function(e){var t={};function s(i){if(t[i])return t[i].exports;var o=t[i]={i:i,l:!1,exports:{}};return e[i].call(o.exports,o,o.exports,s),o.l=!0,o.exports}s.m=e,s.c=t,s.d=function(e,t,i){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)s.d(i,o,function(t){return e[t]}.bind(null,o));return i},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=18)}([function(e,t,s){"use strict";s.r(t),s.d(t,"images",(function(){return i})),s.d(t,"config",(function(){return o}));var i={tile:s(1),tileBlock:s(2),field:s(3),moves:s(4),bar:s(5),barBack:s(6),scorePanel:s(7),topPanel:s(8),background:s(9),progressPanel:s(10),pauseBase:s(11),pauseHover:s(12),pausePress:s(13),buttonBase2:s(14),buttonHover2:s(15),buttonPress2:s(16)},o={screenWidth:1e3,screenHeight:700,gridWidth:500,gridHeight:500,gridX:50,gridY:150,cellsX:7,cellsY:7,variety:5,scoreToWin:2e3,movesLimit:50,shuffles:3,minGroup:2,superGroup:4,boosters:2,boostR:1,preloaderDelay:1500}},function(e,t,s){e.exports=s.p+"./images/tile.png"},function(e,t,s){e.exports=s.p+"./images/blocks.png"},function(e,t,s){e.exports=s.p+"./images/field.png"},function(e,t,s){e.exports=s.p+"./images/moves.png"},function(e,t,s){e.exports=s.p+"./images/bar.png"},function(e,t,s){e.exports=s.p+"./images/bar_back.png"},function(e,t,s){e.exports=s.p+"./images/score_panel.png"},function(e,t,s){e.exports=s.p+"./images/top_panel.png"},function(e,t,s){e.exports=s.p+"./images/background.png"},function(e,t,s){e.exports=s.p+"./images/progress_panel.png"},function(e,t,s){e.exports=s.p+"./images/pause_base.png"},function(e,t,s){e.exports=s.p+"./images/pause_hover.png"},function(e,t,s){e.exports=s.p+"./images/pause_press.png"},function(e,t,s){e.exports=s.p+"./images/button2_base.png"},function(e,t,s){e.exports=s.p+"./images/button2_hover.png"},function(e,t,s){e.exports=s.p+"./images/button2_press.png"},function(e,t,s){},function(e,t,s){"use strict";s.r(t);s(17);var i=s(0);function o(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e+1))+e}class h{constructor(e,t,s,i,o){this._cellsX=e,this._cellsY=t,this._variety=s-1,this._minGroup=i,this._superGroup=o,this._field=[],this._empty_cell=-1,this._super_cell=s,this._group=void 0,this.init(),this.randomFill()}init(){for(let e=0;e<this._cellsY;e++)for(let t=0;t<this._cellsX;t++){let s={type:this._empty_cell,x:t,y:e,dx:t,dy:e};this._field.push(s)}}randomFill(){const e=this._field.filter(e=>e.type===this._empty_cell);return e.forEach(e=>e.type=o(0,this._variety)),e}getCell(e,t){return this._field.find(s=>s.x==e&&s.y==t)}setSuperCell(e,t){this.getCell(e,t).type=this._super_cell}isSupercell(e,t){return this.getCell(e,t).type==this._super_cell}_getGroup(e,t,s,i=[]){const o=e>=0&&e<this._cellsX,h=t>=0&&t<this._cellsY;if(!o||!h)return i;if(void 0===s)return s=this.getCell(e,t).type,this._getGroup(e,t,s,i);if(this.getCell(e,t).type!=s)return i;if(i.find(s=>s.x==e&&s.y==t))return i;i.push({x:e,y:t});return[{x:e+1,y:t},{x:e-1,y:t},{x:e,y:t+1},{x:e,y:t-1}].forEach(e=>this._getGroup(e.x,e.y,s,i)),i}getGroup(e,t){return this.getCell(e,t).type==this._super_cell?this._group=this.getCross(e,t):this._group=this._getGroup(e,t),this._group}getCross(e,t){this._group=[];for(let e=0;e<this._cellsX;e++)this._group.push({x:e,y:t});for(let t=0;t<this._cellsY;t++)this._group.push({x:e,y:t});return this._group}getRadius(e,t,s){const i=Math.max(e-s,0),o=Math.min(e+s,this._cellsX-1),h=Math.max(t-s,0),n=Math.min(t+s,this._cellsY-1);this._group=[];for(let e=i;e<=o;e++)for(let t=h;t<=n;t++)this._group.push({x:e,y:t});return this._group}getRow(e,t){const s=[];for(let e=0;e<this._cellsX;e++)s.push({x:e,y:t});return this._group=s,this._group}clearCell(e,t){this.getCell(e,t).type=this._empty_cell}clearGroup(){this._group.forEach(e=>this.clearCell(e.x,e.y))}isEmpty(e,t){return this.getCell(e,t).type==this._empty_cell}swapCells(e,t,s,i){let o=this.getCell(e,t),h=this.getCell(s,i);o.x=s,o.y=i,h.x=e,h.y=t}getChanges(){return this._field.filter(e=>(e.x!=e.dx||e.y!=e.dy)&&e.type!=this._empty_cell)}fixChanges(){this._field.forEach(e=>{e.dx=e.x,e.dy=e.y})}collapse(){this.clearGroup();for(let e=0;e<this._cellsX;e++){let t=0;for(let s=this._cellsY-1;s>=0;s--)this.isEmpty(e,s)?t++:this.swapCells(e,s,e,s+t)}}shuffle(){this._field.forEach(e=>{let t=o(0,this._field.length-1);this.swapCells(e.x,e.y,this._field[t].x,this._field[t].y)})}getMoves(){let e=0,t=this._field.slice(0);for(;t.length>0;){const s=t[0],i=this._getGroup(s.x,s.y);i.length>=this._minGroup&&e++,i.forEach(e=>{t=t.filter(t=>t.x!=e.x||t.y!=e.y)})}return e}}class n{constructor(e,t,s,i){this._container=e,this._canvas=document.createElement("canvas"),this._canvas.width=t,this._canvas.height=s,this._ctx=this._canvas.getContext("2d"),this._renderQueue=[],this._renderScene=void 0,this._taskQueue=[],this._stopEngine=!0,this._background_color=i,this._background_image=void 0,this._canvas.textContent="Sorry, but your browser is not supported :(",this._canvas.addEventListener("mousedown",e=>this._mouseDown(e)),this._canvas.addEventListener("mouseup",e=>this._mouseUp(e)),this._canvas.addEventListener("mousemove",e=>this._mouseMove(e)),this.deploy()}getContext(){return this._ctx}deploy(){this._container.appendChild(this._canvas)}setBackgroundImage(e){this._background_image=e}retract(){this._container.removeChild(this._canvas)}clear(){this._ctx.clearRect(0,0,this._canvas.width,this._canvas.height),this._background_image?this._ctx.drawImage(this._background_image,0,0,this._canvas.width,this._canvas.height):this._background_color&&(this._ctx.fillStyle=this._background_color,this._ctx.fillRect(0,0,this._canvas.width,this._canvas.height))}addLayer(e){this._renderQueue.push(e)}addTask(e){this._taskQueue.push(e)}setScene(e){this._renderScene=e}clearScene(){this._renderScene=void 0}renderEngineStart(){this._stopEngine=!1,this._renderStep()}renderEngineStop(){this._stopEngine=!0}_renderStep(){this._stopEngine||(this.clear(),this._renderScene?this._renderScene.render(this._ctx):this._renderQueue.forEach(e=>e.render(this._ctx)),this._taskQueue.forEach(e=>e()),requestAnimationFrame(()=>this._renderStep()))}_mouseDown(e){let t=e.offsetX,s=e.offsetY;this._renderScene?this._renderScene.onPress(t,s):this._renderQueue.forEach(e=>e.onPress(t,s))}_mouseUp(e){let t=e.offsetX,s=e.offsetY;this._renderScene?this._renderScene.onRelease(t,s):this._renderQueue.forEach(e=>e.onRelease(t,s))}_mouseMove(e){let t=e.offsetX,s=e.offsetY;this._renderScene?this._renderScene.onMove(t,s):this._renderQueue.forEach(e=>e.onMove(t,s))}}class r{constructor(e){this.imageFiles=e,this.images={}}load(){const e=[];for(let t in this.imageFiles)e.push(this._loadImage(t,this.imageFiles[t]));return Promise.all(e)}_loadImage(e,t){return new Promise((s,i)=>{const o=new Image;this.images[e]=o,o.onload=()=>s(e),o.onerror=s=>{console.log(`Image load error: ${e}, ${t}`),i(s)},o.src=t})}}class a{constructor(){this.images=[]}init(e,t){this._image=e,this._divider=t,this._spriteWidth=e.width/t}split(){const e=document.createElement("canvas"),t=e.getContext("2d"),s=[];e.width=this._spriteWidth,e.height=this._image.height;for(let i=0;i<this._divider;i++)t.clearRect(0,0,e.width,e.height),s.push(this._splitPart(e,t,i));return Promise.all(s)}_splitPart(e,t,s){return new Promise((i,o)=>{const h=new Image,n=this._spriteWidth*s,r=this._spriteWidth,a=e.height;t.drawImage(this._image,n,0,r,a,0,0,e.width,e.height);const l=e.toDataURL("image/png");h.onload=()=>i(h),h.onerror=e=>{console.log("Image load error: "+l),o(e)},this.images.push(h),h.src=l})}}class l{constructor(){this._x=0,this._y=0,this._dx=0,this._dy=0,this._width=0,this._height=0,this._anchorX=0,this._anchorY=0,this._background=void 0,this._alpha=1,this._borders={leftTop:0,rightTop:0,leftBottom:0,rightBottom:0},this._hitbox={left:0,right:0,top:0,bottom:0},this._clickHandler=void 0,this._pressHandler=void 0,this._releaseHandler=void 0,this._hoverHandler=void 0,this._hoverInHandler=void 0,this._hoverOutHandler=void 0,this._removeHandler=void 0,this._isPressed=!1,this._isHovered=!1,this._eEnabled=!0,this._serialTaskQueue=[],this._parallelTaskQueue=[]}setPosition(e,t){this._x=e,this._y=t,this._refresh()}_refresh(){this._dx=this._x-this._width*this._anchorX,this._dy=this._y-this._height*this._anchorY,this._borders.leftTop=this._dx,this._borders.leftTop=this._dx;const e=this._width*this._anchorX,t=this._height*this._anchorY;this._x,this._width,this._hitbox.left,this._x,this._width,this._width,this._hitbox.right,this._y,this._height,this._hitbox.top,this._y,this._height,this._height,this._hitbox.bottom}getPosition(){return{x:this._x,y:this._y}}setX(e){this._x=e,this._refresh()}setY(e){this._y=e,this._refresh()}setSize(e,t){this._width=e,this._height=t,this._refresh()}getSize(){return{width:this._width=width,height:this._height=height}}setAnchor(e,t){this._anchorX=e,this._anchorY=t,this._refresh()}setHitbox(e,t,s,i){this._hitbox.left=e,this._hitbox.right=t,this._hitbox.top=s,this._hitbox.bottom=i}setBackgroundImage(e){this._background=e}resizeOnBackground(){this._width=this._background.width,this._height=this._background.height,this._refresh()}scaleOnBackground(e){this._width=this._background.width*e,this._height=this._background.height*e,this._refresh()}scaleOnBackgroundWidth(e){const t=e/this._background.width;this.scaleOnBackground(t)}scaleOnBackgroundHeight(e){const t=e/this._background.height;this.scaleOnBackground(t)}_isHit(e,t){const s=this._dx+this._width*this._hitbox.left,i=this._dx+this._width-this._width*this._hitbox.right,o=this._dy+this._height*this._hitbox.top,h=this._dy+this._height-this._height*this._hitbox.bottom;return!!(e>=s&&e<i&&t>=o&&t<h)}onPress(e,t){this._isHit(e,t)&&(this._isPressed=!0,this._pressHandler&&this._eEnabled&&this._pressHandler(this))}onRelease(e,t){this._isPressed&&(this._isPressed=!1,this._releaseHandler&&this._eEnabled&&this._releaseHandler(this),this._isHit(e,t)&&this._eEnabled&&this._onClick())}onMove(e,t){let s=this._isHit(e,t);this._isHovered||!s?!this._isHovered||s?this._isHovered&&s&&this._hoverHandler&&this._eEnabled&&this._hoverHandler():this._hoverOutHandler&&this._eEnabled&&(this._isHovered=!1,this._hoverOutHandler()):this._hoverInHandler&&this._eEnabled&&(this._isHovered=!0,this._hoverInHandler())}_onClick(){this._clickHandler&&this._eEnabled&&this._clickHandler(this)}onRemove(){this._removeHandler&&this._eEnabled&&this._clickHandler(this)}setClickHandler(e){this._clickHandler=e}setRemoveHandler(e){this._removeHandler=e}setHoverInHandler(e){this._hoverInHandler=e}setHoverOutHandler(e){this._hoverOutHandler=e}setHoverHandler(e){this._hoverHandler=e}setPressHandler(e){this._pressHandler=e}setReleaseHandler(e){this._releaseHandler=e}addParallelTask(e){this._parallelTaskQueue.push(e)}addSerialTask(e){this._serialTaskQueue.push(e)}getSerialQueueSize(){return this._serialTaskQueue.length}getParallelQueueSize(){return this._parallelTaskQueue.length}disableEvents(){this._eEnabled=!1}enableEvents(){this._eEnabled=!0}render(e){e.globalAlpha=this._alpha,this._parallelTaskQueue.forEach(e=>{e(this)&&(this._parallelTaskQueue=this._parallelTaskQueue.filter(t=>t!=e))}),this._serialTaskQueue.length>0&&this._serialTaskQueue[0](this)&&this._serialTaskQueue.shift(),null!=this._background&&e.drawImage(this._background,this._dx,this._dy,this._width,this._height),e.globalAlpha=this.alpha}}const c=[0,.109375];function g(e,t){if(t<0||void 0===t)return;const s=new l;return s.setBackgroundImage(e[t]),s.resizeOnBackground(),s.setAnchor(...c),s}class d{constructor(){this.collection={}}addComponent(e,t){this.collection[e]=t}onPress(e,t){for(let s in this.collection)this.collection[s].onPress(e,t)}onRelease(e,t){for(let s in this.collection)this.collection[s].onRelease(e,t)}onMove(e,t){for(let s in this.collection)this.collection[s].onMove(e,t)}render(e){for(let t in this.collection)this.collection[t].render(e)}}class u extends l{constructor(e,t,s=1){super(),this._cellsX=e,this._cellsY=t,this._ratio=s,this._collection=[],this._stepX=0,this._stepY=0,this._paddingV=.1,this._paddingH=.1,this._removeQueue=[],this._eventPropagation=!0}_gridRecalc(){this._stepX=(this._width-this._width*this._paddingH)/this._cellsX,this._stepY=(this._height-this._height*this._paddingV)/this._cellsY}setSize(e,t){super.setSize(e,t),this._gridRecalc()}getInstanceAddress(e){const t=this._collection.find(t=>t.instance===e);return{x:t.cellX,y:t.cellY}}updateItems(){this._collection.forEach(e=>{null!=e.updateX&&(e.cellX=e.updateX),null!=e.updateY&&(e.cellY=e.updateY)})}sortCollection(){this._collection.sort((e,t)=>t.cellY-e.cellY)}addItem(e,t,s){const i=this.getCellLocation(t,s);e.setPosition(i.x,i.y),e.scaleOnBackgroundWidth(this._stepX);const o={instance:e,cellX:t,cellY:s,updateX:void 0,updateY:void 0};this._collection.push(o)}getCell(e,t){return this._collection.find(s=>s.cellX===e&&s.cellY===t)}getInstance(e,t){return this.getCell(e,t).instance}getCellLocation(e,t){return{x:this._x+this._stepX*e+this._width*this._paddingV/2,y:this._y+this._stepY*t+this._height*this._paddingH/2}}removeItem(e){this._removeQueue.push(e)}onPress(e,t){super.onPress(e,t),this._eventPropagation&&this._collection.forEach(s=>s.instance.onPress(e,t))}onRelease(e,t){super.onRelease(e,t),this._eventPropagation&&this._collection.forEach(s=>s.instance.onRelease(e,t))}stopEventPropagation(){this._eventPropagation=!1}allowEventPropagation(){this._eventPropagation=!0}render(e){this.sortCollection(),this._removeQueue.forEach(e=>{e.onRemove(),this._collection=this._collection.filter(t=>t.instance!=e)}),this._removeQueue=[],super.render(e),this._collection.forEach(t=>t.instance.render(e))}}class _ extends l{constructor(e=14,t="#00",s="serif",i=""){super(),this._fontsize=e,this._font=s,this._baseline="middle",this._textcolor=t,this.setText(i)}setText(e){this._text=e.toString()}render(e){super.render(e),e.font=`${this._fontsize}px ${this._font}`,e.fillStyle=this._textcolor,e.textBaseline=this._baseline;let t=e.measureText(this._text),s=this._x+(this._width-t.width)/2,i=this._y+this._height/2;s-=this._width*this._anchorX,i-=this._height*this._anchorY,e.fillText(this._text,s,i)}}class p extends _{constructor(e=14,t="#00",s="serif",i=""){super(e,t,s,i),this._baseImg=void 0,this._hoverImg=void 0,this._pressImg=void 0,this.setHoverInHandler(()=>{!this._isPressed&&this._hoverImg&&this.setBackgroundImage(this._hoverImg)}),this.setHoverOutHandler(()=>{!this._isPressed&&this._baseImg&&this.setBackgroundImage(this._baseImg)}),this.setPressHandler(()=>{this._pressImg&&this.setBackgroundImage(this._pressImg)}),this.setReleaseHandler(()=>{this._isHovered?this.setBackgroundImage(this._hoverImg):this.setBackgroundImage(this._baseImg)})}setBaseImage(e){this._baseImg=e,this.setBackgroundImage(e)}setHoverImage(e){this._hoverImg=e}setPressImage(e){this._pressImg=e}}class m extends p{constructor(e=14,t="#00",s="serif",i=""){super(e,t,s,i),this._isFixed=!1}getState(){return this._isFixed}fix(){this._isFixed=!0}reset(){this._isFixed=!1,this.setBackgroundImage(this._baseImg)}_onClick(){this._isFixed=!this._isFixed,super._onClick()}render(e){this._isFixed&&this.setBackgroundImage(this._pressImg),super.render(e)}}class f extends l{constructor(){super(),this._progress=0,this._progressX=0,this._progressY=0,this._progressWidth=0,this._progressStop=0,this._outerRadius=0,this._innerRadius=0,this._bar=void 0,this._border=0}_refresh(){super._refresh(),this._outerRadius=this._height/2,this._innerRadius=this._outerRadius-this._border,this._progressWidth=this._width-2*this._outerRadius,this._progressX=this._dx+this._outerRadius,this._progressY=this._dy+this._outerRadius}setProgress(e){e>1&&(e=1),this._progress=e,this._progressStop=this._progressWidth*e}setBarImage(e){this._bar=e}setBorder(e){this._border=e,this._refresh()}_clipper(e,t,s,i,o,h){e.beginPath(),e.arc(t,s,i,Math.PI/2,Math.PI+Math.PI/2,!1),e.arc(t+o,s,i,Math.PI+Math.PI/2,Math.PI/2,!1),e.closePath(),e.save(),e.clip(),h(),e.restore()}render(e){this._clipper(e,this._progressX,this._progressY,this._outerRadius,this._progressWidth,()=>super.render(e)),this._clipper(e,this._progressX,this._progressY,this._innerRadius,this._progressStop,()=>e.drawImage(this._bar,this._dx,this._dy,this._width,this._height))}}class b extends d{constructor(e){super(),this.game=e,this.addComponent("layout",new l),this.addComponent("grid",new u(i.config.cellsX,i.config.cellsY)),this.addComponent("scorePanel",new l),this.addComponent("topPanel",new l),this.addComponent("progressPanel",new l),this.addComponent("movesCaption",new _(30,"#FFF","Roboto Slab","Ходы:")),this.addComponent("movesLabel",new _(90,"#FFF","Roboto Slab")),this.addComponent("scoreCaption",new _(30,"#FFF","Roboto Slab","Очки:")),this.addComponent("scoreLabel",new _(50,"#FFF","Roboto Slab",0)),this.addComponent("bannerLabel",new _(90,"#CFF","Roboto Slab")),this.addComponent("groupsLabel",new _(20,"#FFF","Roboto Slab")),this.addComponent("shuffleButton",new p(20,"#FFF","Roboto Slab",`Перемешать (x${i.config.shuffles})`)),this.addComponent("boosterButton",new m(20,"#FFF","Roboto Slab",`Бустер (x${i.config.boosters})`)),this.addComponent("pauseButton",new m),this.addComponent("progress",new f),this.addComponent("progressLabel",new _(20,"#FFF","Roboto Slab","Прогресс"))}init(){this.collection.layout.setBackgroundImage(this.game.assets.images.background),this.collection.layout.setSize(i.config.screenWidth,i.config.screenHeight),this.collection.grid.setBackgroundImage(this.game.assets.images.field),this.collection.grid.setSize(i.config.gridWidth,i.config.gridHeight),this.collection.grid.setPosition(i.config.gridX,i.config.gridY),this.collection.scorePanel.setBackgroundImage(this.game.assets.images.scorePanel),this.collection.scorePanel.setAnchor(.5,.5),this.collection.scorePanel.scaleOnBackgroundWidth(300),this.collection.scorePanel.setPosition(780,300),this.collection.movesCaption.setPosition(780,160),this.collection.movesLabel.setBackgroundImage(this.game.assets.images.moves),this.collection.movesLabel.setAnchor(.5,.7),this.collection.movesLabel.scaleOnBackgroundWidth(180),this.collection.movesLabel.setText(i.config.movesLimit),this.collection.movesLabel.setPosition(780,300),this.collection.scoreCaption.setPosition(780,370),this.collection.scoreLabel.setPosition(780,410),this.collection.bannerLabel.setPosition(i.config.screenWidth/2,i.config.screenHeight/2),this.collection.groupsLabel.setPosition(150,130),this.collection.shuffleButton.setBaseImage(this.game.assets.images.buttonBase2),this.collection.shuffleButton.setHoverImage(this.game.assets.images.buttonHover2),this.collection.shuffleButton.setPressImage(this.game.assets.images.buttonPress2),this.collection.shuffleButton.setPosition(780,500),this.collection.shuffleButton.setAnchor(.5,.5),this.collection.shuffleButton.scaleOnBackgroundWidth(200),this.collection.shuffleButton.setSize(200,60),this.collection.shuffleButton.setClickHandler(this.game.shuffleClickHandler()),this.collection.boosterButton.setBaseImage(this.game.assets.images.buttonBase2),this.collection.boosterButton.setHoverImage(this.game.assets.images.buttonHover2),this.collection.boosterButton.setPressImage(this.game.assets.images.buttonPress2),this.collection.boosterButton.setPosition(780,570),this.collection.boosterButton.setAnchor(.5,.5),this.collection.boosterButton.scaleOnBackgroundWidth(200),this.collection.boosterButton.setSize(200,60),this.collection.boosterButton.setClickHandler(this.game.boosterClickHandler()),this.collection.pauseButton.setBaseImage(this.game.assets.images.pauseBase),this.collection.pauseButton.setHoverImage(this.game.assets.images.pauseHover),this.collection.pauseButton.setPressImage(this.game.assets.images.pausePress),this.collection.pauseButton.setPosition(930,50),this.collection.pauseButton.setAnchor(.5,.5),this.collection.pauseButton.scaleOnBackgroundWidth(60),this.collection.pauseButton.setClickHandler(this.game.pauseClickHandler()),this.collection.progress.setBackgroundImage(this.game.assets.images.barBack),this.collection.progress.setBarImage(this.game.assets.images.bar),this.collection.progress.setSize(300,25),this.collection.progress.setAnchor(.5,.5),this.collection.progress.setPosition(i.config.screenWidth/2,45),this.collection.progress.setBorder(3),this.collection.progress.setProgress(0),this.collection.topPanel.setBackgroundImage(this.game.assets.images.topPanel),this.collection.topPanel.setSize(700,100),this.collection.topPanel.setAnchor(.5,0),this.collection.topPanel.setPosition(i.config.screenWidth/2,0),this.collection.progressPanel.setBackgroundImage(this.game.assets.images.progressPanel),this.collection.progressPanel.setSize(400,70),this.collection.progressPanel.setAnchor(.5,0),this.collection.progressPanel.setPosition(i.config.screenWidth/2,0),this.collection.progressLabel.setPosition(i.config.screenWidth/2,15)}}class v extends d{constructor(e){super(),this.game=e,this.addComponent("waitLabel",new _(50,"#000","Roboto Slab","Загрузка...")),this.init()}init(){this.collection.waitLabel.setPosition(i.config.screenWidth/2,i.config.screenHeight/2)}}function x(e,t,s,i){let o=void 0,h=void 0;return n=>{null==o&&(o=n._x<e?1:-1,h=n._y<t?1:-1);let r=n.getPosition();return r.x+=o*(s+i)/60,r.y+=h*(s+i)/60,n.setPosition(r.x,r.y),r.x*o>e*o&&n.setX(e),r.y*h>t*h&&n.setY(t),n._x==e&&n._y==t}}class y{constructor(e){this.screen=new n(e,i.config.screenWidth,i.config.screenHeight),this.game=new h(i.config.cellsX,i.config.cellsY,i.config.variety,i.config.minGroup,i.config.superGroup),this.assets=new r(i.images),this.tiles=new a,this.gameScene=new b(this),this.preloaderScene=new v(this),this.sprites=[],this.state={isPressed:!1,isRemoving:!1,isMoving:!1,isShuffling:!1,isBoosted:!1,isSupercell:!1,target:void 0,address:void 0,group:[],changes:void 0,moves:i.config.movesLimit,score:0,shuffles:i.config.shuffles,boosters:i.config.boosters},this.screen.setScene(this.preloaderScene),this.screen.renderEngineStart(),this.assets.load().then(()=>{this.tiles.init(this.assets.images.tileBlock,5),this.tiles.split().then(()=>{this.sprites=this.tiles.images,setTimeout(()=>this.init(),i.config.preloaderDelay)})}).catch(e=>console.log(e))}init(){this.gameScene.init();for(let e=0;e<i.config.cellsX;e++)for(let t=0;t<i.config.cellsY;t++){const s=g(this.sprites,this.game.getCell(e,t).type);s.setClickHandler(this.tileClickHandler(this.state)),this.gameScene.collection.grid.addItem(s,e,t)}this.screen.setScene(this.gameScene),this.screen.addTask(()=>this.loop())}tileClickHandler(){return e=>{this.state.isPressed=!0,this.state.target=e}}pauseClickHandler(){return e=>{e.getState()?(this.gameScene.collection.bannerLabel.setText("Пауза"),this.uiLock()):(this.gameScene.collection.bannerLabel.setText(""),this.uiUnlock())}}boosterClickHandler(){return e=>{e.getState()&&this.state.boosters>0?this.state.isBoosted=!0:this.state.isBoosted=!1}}shuffleClickHandler(){return e=>{0!=this.state.shuffles&&(this.state.shuffles--,e.setText(`Перемешать (x${this.state.shuffles})`),this.state.isShuffling=!0)}}uiLock(){this.gameScene.collection.grid.stopEventPropagation(),this.gameScene.collection.shuffleButton.disableEvents(),this.gameScene.collection.boosterButton.disableEvents()}uiUnlock(){this.gameScene.collection.grid.allowEventPropagation(),this.gameScene.collection.shuffleButton.enableEvents(),this.state.boosters>0&&this.gameScene.collection.boosterButton.enableEvents()}loop(){if(this.state.isPressed){if(this.state.address=this.gameScene.collection.grid.getInstanceAddress(this.state.target),this.state.isBoosted?(this.state.group=this.game.getRadius(this.state.address.x,this.state.address.y,i.config.boostR),this.state.boosters--,this.gameScene.collection.boosterButton.setText(`Бустер (x${this.state.boosters})`)):(this.state.supercell=this.game.isSupercell(this.state.address.x,this.state.address.y),this.state.group=this.game.getGroup(this.state.address.x,this.state.address.y)),this.state.group.length<i.config.minGroup)return void(this.state.isPressed=!1);this.uiLock(),this.state.group=this.state.group.map(e=>this.gameScene.collection.grid.getCell(e.x,e.y)),this.state.group.forEach(e=>e.instance.addSerialTask(function(e,t,s,i){let o=e;return t<0&&(t=0),e=>(o-=(s+i)/60,o<t&&(o=t),e._alpha=o,o<=t)}(1,.4,1,2))),this.state.isPressed=!1,this.state.isRemoving=!0,this.state.moves--,this.state.score+=Math.pow(this.state.group.length,2)}if(this.state.isRemoving)this.state.isRemoving=!1,this.state.group.forEach(e=>{e.instance.getSerialQueueSize()>0?this.state.isRemoving=!0:this.gameScene.collection.grid.removeItem(e.instance)}),this.state.isRemoving||(this.game.collapse(),this.state.changes=this.game.getChanges(),this.state.changes=this.state.changes.map(e=>{const t=this.gameScene.collection.grid.getCell(e.dx,e.dy);let s=this.gameScene.collection.grid.getCellLocation(e.x,e.y);return t.instance.addSerialTask(x(s.x,s.y,100,300)),t.updateX=e.x,t.updateY=e.y,t}),this.state.isMoving=!0);else if(this.state.isMoving&&(this.state.isMoving=!1,this.state.changes.forEach(e=>{e.instance.getSerialQueueSize()>0&&(this.state.isMoving=!0)}),!this.state.isMoving)){this.gameScene.collection.grid.updateItems();if(this.game.randomFill().forEach(e=>{const t=g(this.sprites,e.type);t.setClickHandler(this.tileClickHandler(this.state)),this.gameScene.collection.grid.addItem(t,e.x,e.y)}),this.gameScene.collection.movesLabel.setText(this.state.moves),this.gameScene.collection.scoreLabel.setText(this.state.score),this.gameScene.collection.progress.setProgress(this.state.score/i.config.scoreToWin),this.state.score>=i.config.scoreToWin)this.gameScene.collection.bannerLabel.setText("Вы победили");else if(0==this.state.moves)this.gameScene.collection.bannerLabel.setText("Вы проиграли");else{this.game.fixChanges();const e=this.game.getMoves();this.gameScene.collection.groupsLabel.setText("Доступно ходов: "+this.game.getMoves()),this.state.group.length>=i.config.superGroup&&!this.state.isBoosted&&!this.state.supercell&&!this.state.isShuffling&&(this.game.setSuperCell(this.state.address.x,this.state.address.y),this.gameScene.collection.grid.getCell(this.state.address.x,this.state.address.y).instance.addParallelTask(function(e){const t=60/e;let s=!1,i=0;return e=>(i+=1,i==t&&(i=0,s=!s),e._alpha=1*s,!1)}(20))),this.state.shuffles||this.state.boosters||e||this.gameScene.collection.bannerLabel.setText("Вы проиграли"),this.state.isBoosted=!1,this.gameScene.collection.boosterButton.reset(),this.state.isShuffling=!1,this.uiUnlock()}}this.state.isShuffling&&!this.state.isMoving&&(this.uiLock(),this.game.shuffle(),this.state.changes=[],this.game._field.forEach(e=>{const t=this.gameScene.collection.grid.getCell(e.dx,e.dy);let s=this.gameScene.collection.grid.getCellLocation(e.x,e.y);t.instance.addSerialTask(x(s.x,s.y,100,300)),t.updateX=e.x,t.updateY=e.y,this.state.changes.push(t)}),this.state.isMoving=!0)}}window.onload=function(){var e=document.querySelector(".main");new y(e)}}]);